apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: default
  namespace: karpenter
  annotations:
    argocd.argoproj.io/sync-wave: "4"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  # Amazon Linux 2023 AMI family
  # Using Custom AMI family with AL2023 AMI selection
  amiFamily: Custom
  
  # Select Amazon Linux 2023 AMIs for K3s (both x86_64 and ARM64)
  amiSelectorTerms:
    # Amazon Linux 2023 x86_64
    - name: "al2023-ami-2023.*-kernel-*-x86_64"
      owner: "137112412989" # Amazon
    # Amazon Linux 2023 ARM64
    - name: "al2023-ami-2023.*-kernel-*-arm64"
      owner: "137112412989" # Amazon
        
  # Instance profile (pre-created for K3s)
  instanceProfile: {{ .Values.environmentConfig.bootstrap.karpenterInstanceProfile }}
  
  # Subnet selection - use karpenter discovery tags to avoid kubernetes.io restrictions
  subnetSelectorTerms:
    # Select by karpenter discovery tag only
    - tags:
        karpenter.sh/discovery/{{ .Values.environmentConfig.bootstrap.clusterName }}: "{{ .Values.environmentConfig.bootstrap.clusterName }}"
  # Security group selection  
  securityGroupSelectorTerms:
    # Select by karpenter discovery tag (more specific)
    - tags:
        karpenter.sh/discovery/{{ .Values.environmentConfig.bootstrap.clusterName }}: "{{ .Values.environmentConfig.bootstrap.clusterName }}"
        
  # Custom UserData for K3s node joining
  userData: |
    #!/bin/bash
    set -e
    
    # ECR Credential Provider version (renovate-friendly)
    ECR_CREDENTIAL_PROVIDER_VERSION="v1.35.0"
    
    # Disable firewalld (AL2023 has it enabled by default)
    # Required for K3s networking (kubelet, VXLAN, etc.)
    systemctl stop firewalld || true
    systemctl disable firewalld || true
    
    # Install required packages (curl and awscli are pre-installed on AL2023)
    dnf install -y jq git
    
    # Get IMDSv2 token for architecture detection
    TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
    
    # Detect architecture from system
    ARCH=$(uname -m)
    if [ "$ARCH" = "aarch64" ]; then
      ARCH="arm64"
    elif [ "$ARCH" = "x86_64" ]; then
      ARCH="amd64"
    fi
    
    # Install ECR Credential Provider
    mkdir -p /var/lib/rancher/credentialprovider/bin
    curl -L "https://github.com/loafoe/cloud-provider-aws/releases/download/${ECR_CREDENTIAL_PROVIDER_VERSION}/ecr-credential-provider-linux-${ARCH}" \
      -o /var/lib/rancher/credentialprovider/bin/ecr-credential-provider
    chmod +x /var/lib/rancher/credentialprovider/bin/ecr-credential-provider
    
    # Create credential provider configuration
    mkdir -p /var/lib/rancher/credentialprovider
    cat > /var/lib/rancher/credentialprovider/config.yaml << 'EOF'
    apiVersion: kubelet.config.k8s.io/v1
    kind: CredentialProviderConfig
    providers:
      - name: ecr-credential-provider
        matchImages:
          - "*.dkr.ecr.*.amazonaws.com"
          - "*.dkr.ecr.*.amazonaws.com.cn"
          - "*.dkr.ecr-fips.*.amazonaws.com"
          - "*.dkr.ecr.us-iso-east-1.c2s.ic.gov"
          - "*.dkr.ecr.us-isob-east-1.sc2s.sgov.gov"
        defaultCacheDuration: "12h"
        apiVersion: credentialprovider.kubelet.k8s.io/v1
    EOF
    
    # Increase file descriptor limits to handle many containers
    # Using 100000 to account for container runtime overhead (some containers inherit ~64512 instead of 65536)
    echo "# File descriptor limits for high container density" >> /etc/security/limits.conf
    echo "* soft nofile 100000" >> /etc/security/limits.conf
    echo "* hard nofile 100000" >> /etc/security/limits.conf
    echo "root soft nofile 100000" >> /etc/security/limits.conf
    echo "root hard nofile 100000" >> /etc/security/limits.conf
    
    # Set system-wide limits for systemd services
    mkdir -p /etc/systemd/system.conf.d
    cat > /etc/systemd/system.conf.d/limits.conf << 'EOF'
    [Manager]
    DefaultLimitNOFILE=100000
    DefaultLimitNPROC=32768
    EOF
    
    # Set limits for current session
    ulimit -n 100000
    ulimit -u 32768
    
    # Reload systemd to pick up new limits
    systemctl daemon-reload
    
    # Create K3s service override to ensure it gets higher limits
    mkdir -p /etc/systemd/system/k3s-agent.service.d
    cat > /etc/systemd/system/k3s-agent.service.d/limits.conf << 'EOF'
    [Service]
    LimitNOFILE=100000
    LimitNPROC=32768
    EOF
    
    # Get instance metadata for provider-id using IMDSv2 (reuse TOKEN from earlier)
    INSTANCE_ID=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/instance-id)
    AZ=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
    REGION=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/placement/region)
    INSTANCE_TYPE=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/instance-type)
    
    # Retrieve K3s token securely from AWS Systems Manager Parameter Store
    K3S_TOKEN=$(aws ssm get-parameter \
      --name "{{ .Values.environmentConfig.bootstrap.k3sTokenParameterName }}" \
      --with-decryption \
      --region "$REGION" \
      --query "Parameter.Value" \
      --output text)
    
    if [ -z "$K3S_TOKEN" ]; then
      echo "Failed to retrieve K3s token from Parameter Store"
      exit 1
    fi
    
    # Retrieve K3s version from AWS Systems Manager Parameter Store
    DETECTED_K3S_VERSION=$(aws ssm get-parameter \
      --name "{{ .Values.environmentConfig.bootstrap.k3sVersionParameterName }}" \
      --region "$REGION" \
      --query "Parameter.Value" \
      --output text || echo "")

    if [ -n "$DETECTED_K3S_VERSION" ] && [ "$DETECTED_K3S_VERSION" != "null" ]; then
      echo "Using K3s version from SSM: $DETECTED_K3S_VERSION"
      export INSTALL_K3S_VERSION="$DETECTED_K3S_VERSION"
    else
      echo "Failed to retrieve K3s version from SSM, falling back to channel: {{ .Values.environmentConfig.bootstrap.k3sChannel }}"
      export INSTALL_K3S_CHANNEL="{{ .Values.environmentConfig.bootstrap.k3sChannel }}"
    fi

    # Export K3s environment variables for agent installation
    export K3S_TOKEN="$K3S_TOKEN"
    export K3S_URL="{{ .Values.environmentConfig.bootstrap.clusterEndpoint }}"

    # Install K3s agent
    curl -sfL https://get.k3s.io | sh -s - \
      --node-name kworker-$INSTANCE_ID \
      --kubelet-arg="provider-id=aws:///$AZ/$INSTANCE_ID" \
      --kubelet-arg="cloud-provider=external" \
      --kubelet-arg="register-with-taints=karpenter.sh/unregistered=true:NoExecute" \
      --kubelet-arg="kube-reserved=cpu=250m,memory=512Mi,ephemeral-storage=1Gi" \
      --kubelet-arg="system-reserved=cpu=250m,memory=384Mi,ephemeral-storage=1Gi" \
      --kubelet-arg="enforce-node-allocatable=pods" \
      --kubelet-arg="max-pods=50" \
      --kubelet-arg="image-credential-provider-config=/var/lib/rancher/credentialprovider/config.yaml" \
      --kubelet-arg="image-credential-provider-bin-dir=/var/lib/rancher/credentialprovider/bin" \
      --node-label="node.kubernetes.io/instance-type=$INSTANCE_TYPE" \
      --node-label="topology.kubernetes.io/zone=$AZ"
    
    # Verify K3s agent is running
    systemctl daemon-reload  # Reload again to pick up K3s service overrides
    systemctl enable k3s-agent
    systemctl start k3s-agent
    
    # Wait for kubelet to be ready and node to register
    while ! systemctl is-active --quiet k3s-agent; do
      echo "Waiting for k3s-agent to be active..."
      sleep 5
    done
    
    # Wait for node to appear in cluster (the taint removal will be handled by Karpenter)
    echo "K3s agent started successfully. Node should be registering with cluster..."
    
    # Log successful completion
    echo "Node $(hostname) has completed K3s agent setup"
    
  # Block device mapping for Amazon Linux 2023
  blockDeviceMappings:
    - deviceName: /dev/xvda
      rootVolume: true
      ebs:
        volumeSize: 30Gi
        volumeType: gp3
        encrypted: true
        deleteOnTermination: true
        
  # Additional tags
  tags:
    Name: "{{ .Values.environmentConfig.bootstrap.clusterName }}-karpenter-node"
    ManagedBy: "karpenter"
    Environment: "production"
    
  # Instance metadata options
  metadataOptions:
    httpEndpoint: enabled
    httpProtocolIPv6: disabled
    httpPutResponseHopLimit: 2
    httpTokens: required
